name: Release

on: push
  # workflow_dispatch:

concurrency:
  group: release
  cancel-in-progress: true

jobs:
  # build:
  #   uses: ./.github/workflows/ci.yml

  deploy:
    runs-on: ubuntu-latest
    # needs: [build]
    permissions:
      contents: read
      # issues: write
      # pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn
      - run: yarn install --immutable
      - run: cp ./README.md ./package/README.md
      - run: yarn build
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      - run: |
          echo "github_token=$GITHUB_TOKEN"
          yarn release
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          # YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # pages:
  #   uses: ./.github/workflows/pages.yml
  #   needs: [deploy]
